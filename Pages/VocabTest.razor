@page "/vocab-test"
@inject HttpClient Http
@inject IJSRuntime JsRuntime
@using LatinVocabTest.Data
@using System.Linq


<style>
    #result {
      opacity: 1;
      -webkit-transition: opacity 0.3s ease-in-out;
      -moz-transition: opacity 0.3s ease-in-out;
      -o-transition: opacity 0.3s ease-in-out;
      transition: opacity 0.3s ease-in-out;
    }
    #result.fade {
      opacity:0;
    }
</style>


<PageTitle>Vocab Test</PageTitle>

<h3>Vocab Test</h3>


@if (words == null)
{
    <div class="epicloader"></div>
}
else
{
    <Animate Animation="Animations.FadeLeft" Easing="Easings.EaseOutQuad" Duration="TimeSpan.FromSeconds(1)">

        @foreach(any_word x in words!)
        {
            string[] temp = x.In_English!.Split(",");
            foreach(string y in temp)
            {
                all_latin_words.Add(y.Trim());
            }
        }

        <!-- PRE-PLAY -->
    
        <EditForm Model="selectMode" OnValidSubmit="Start">
            <div style="display: @(InPlay ? "none" : "block"); margin-bottom:10px">
                <h5>Mode:</h5>
                <h6 style="color: red; display: @(selectMode.Success||selectMode.Mode!=null ? "none" : "block")">Please select an option</h6> 

                <div class="form-check">
                    <InputRadioGroup @bind-Value="selectMode.Mode" >
                        @foreach(string x in modes)
                        {
                            <div style="margin-bottom: 5px">
                                <InputRadio id="@x" class="form-check-input" Value="@x" />
                                <label class="form-check-label" for="@x">@x</label>
                                <br/>
                            </div>
                        }
                    </InputRadioGroup>

                    <hr style="margin-left: 0; width:25%;">

                    <div>
                        <input id="check" class="form-check-input" type="checkbox" @bind="@showSuggestions" disabled="@(selectMode.Mode!="Latin to English")"  />
                        <label class="form-check-label" for="check">Show hints (Latin to English only)</label>
                    </div>
                                        
                    <div class="input-group" style="width: 300px; margin-top:10px; margin-bottom:10px; opacity: @(showSuggestions? "1" : "0.5")">
                        <div class="input-group-prepend input-group-sm">
                            <span class="input-group-text" id="inputGroupPrepend3">Show hints after</span>
                        </div>
                        <select class="form-control form-control-sm" @bind="showSuggestionsAfter" aria-describedby="inputGroupPrepend3" disabled="@(!showSuggestions || selectMode.Mode!="Latin to English")" >
                          <option value="3">3 characters</option>
                          <option value="4">4 characters</option>
                          <option value="5">5 characters</option>
                          <option value="6">6 characters</option>
                        </select>
                    </div>                    
                </div>
                <button style="margin-top: 10px" class="btn btn-primary" type="submit">Start</button>
            </div>
        </EditForm>

        <!-- DURING PLAY -->

        <div style=' display: @(!InPlay ? "none" : "block"); margin-left: 5px'>
            <h6 style="font-weight: bold">@testWord</h6>

            <div style="display: flex;">
                <input class="form-control" size="25" style="padding-right:20px; margin:5px 10px 10px 0px" type="text" placeholder="Enter answer here" @oninput="@((e) => 
                    { 
                    enteredValue=(string)e.Value!; if(showSuggestions && selectMode.Mode == "Latin to English") { UpdateStuff(); } })" 
                @onkeydown="@Enter" readonly="@(Q_Answered)"  @bind="@enteredValue"/>
            
                <div id="result" style="flex-basis:40%">
                    <img style="max-width: 100%" src="@imgSource" height="35" width="35"/>
                    <a style="max-width:100%">@correction</a>
                </div>
            </div>

            <!-- SUGGESTIONS -->
            @if(selectMode.Mode=="Latin to English" && showSuggestions)
            {
                string[] suggests = new string[3];
                int i = 0;
                @foreach (var x in querySuggestions)
                {
                    if (i >= 3)
                    {
                        break;
                    }
                    <button style="margin-right:10px;" class="btn btn-sm alert-secondary" @onclick="@(() => { enteredValue=x; UpdateStuff(); QuestionButtonPressed(); })">@x</button>
                    i++;
                }
            }
            
            <br>

            <button style="margin-bottom:10px; margin-top:10px;" class="btn btn-sm btn-primary" @onclick="QuestionButtonPressed">@buttonContent</button>

            <h5>Score: @questions_right/@questions_asked</h5> <p></p>


            @if(selectMode.Mode=="English to Latin")
            {
                <p>Note: give the first principle part for verbs and the nominative singular form for most nouns and adjectives.</p>
            }
            else
            {
                <p>Note: give the meaning of the verbs on their own. E.g. for 'moveo', write 'move', not 'to move'.</p>
            }
            <p>Either hit the enter/return key or click the button to move onto the next question.</p>
        </div>

    </Animate>

}



@code {
    public Random rnd = new Random();
    private int randNum = 0;

    private string enteredValue = "";
    private string? testWord;
    private List<string> testWordAnswer = new List<string>();

    private bool InPlay = false;
    mode selectMode = new mode();
    private string[] modes = { "Latin to English", "English to Latin" };
    private string buttonContent = "";

    private bool Q_Answered = false;
    private string? imgSource = @"images/null.png";
    private string correction = "";

    private int questions_asked = 0;
    private int questions_right = 0;

    private List<string> all_latin_words = new List<string>();
    private any_word[]? words;
    private any_word[]? RVL;
    private char[] forbidden_chars = { '.',',','/','?',';','#','!','-','[',']','\''};

    private List<string> querySuggestions = new List<string>();
    private bool showSuggestions = false;
    private int showSuggestionsAfter = 3;

    private string remove_chars(string x)
    {
        return String.Join("", x.Split(forbidden_chars));
    }

    protected override async Task OnInitializedAsync()
    {
        words = await Http.GetFromJsonAsync<any_word[]>("data/anywords_latin.json");
        RVL = await Http.GetFromJsonAsync<any_word[]>("data/RVL_latin.json");
    }

    async void UpdateStuff()
    {
        querySuggestions.Clear();
        List<string> temp = await PossibleResults(enteredValue);
        querySuggestions = temp.Distinct().ToList();
    }

    private async Task<List<string>> PossibleResults(string searchText)
    {
        if (String.IsNullOrWhiteSpace(searchText))
        {
            return new List<string>();
        } else if (enteredValue.Length >= showSuggestionsAfter)
        {
            return await Task.FromResult(all_latin_words.Where(x => x.ToLower().Contains(searchText.ToLower())).ToList());
        }
        return new List<string>();
        
    }

    private void Start()
    {
        if (selectMode.Mode != null)
        {
            selectMode.Success = true;
            if (!InPlay)
            {
                NextWord();
                InPlay = true;
                buttonContent = "Submit";
            }
        }
        else
        {
            selectMode.Success = false;
        }
    }

    private async void NextWord()
    {
        UpdateStuff();
        questions_asked++;
        Q_Answered = false;

        if (selectMode.Mode=="English to Latin" && RVL is not null)
        {
            randNum = rnd.Next(0, RVL.Length);
            testWord = RVL[randNum].In_English;
            testWordAnswer = new List<string>(RVL[randNum].In_Latin!.Split(','));
        }
        else if (selectMode.Mode=="Latin to English" && words is not null)
        {
            randNum = rnd.Next(0, words.Length);
            testWord = words[randNum].In_Latin;
            testWordAnswer = new List<string>(words[randNum].In_English!.Split(','));
        }
        await resultAnim("0");
    }



    private bool check()
    {
        foreach(string x in testWordAnswer)
        {
            if (remove_chars(x.Trim()).ToUpper() == remove_chars(enteredValue!.Trim()).ToUpper())
            {
                questions_right++;
                return true;
            }
        }
        return false;
    }

    public void Enter(KeyboardEventArgs e)
    {
        if ((e.Code == "Enter" || e.Code == "NumpadEnter"))
        {
            QuestionButtonPressed();
        }
    }

    public async void QuestionButtonPressed()
    {
        if (!String.IsNullOrWhiteSpace(enteredValue))
        {
            if (!Q_Answered)
            {
                bool right = check();
                Q_Answered = true;
                buttonContent = "Next";
                if (right)
                {
                    correction = String.Empty;
                    await resultAnim("correct");
                }
                else
                {
                    if (selectMode.Mode=="English to Latin" && RVL is not null)
                    {
                        correction = $"Correct: {RVL[randNum].In_Latin}";
                    }
                    else if (selectMode.Mode=="Latin to English" && words is not null)
                    {
                        correction = $"Correct: {words[randNum].In_English}";
                    }
                    await resultAnim("incorrect");
                }
            }
            else
            {
                enteredValue = String.Empty;
                NextWord();
                buttonContent = "Submit";
            }
        }
    }

    private async Task resultAnim(string result)
    {
        imgSource = (result != "0") ? $@"images/{result}.png" : imgSource;
        await JsRuntime.InvokeVoidAsync(identifier: "fade","result");
    }


    public class mode
    {
        public string? Mode { get; set; }
        public bool Success { get; set; } = true;
    }
}
